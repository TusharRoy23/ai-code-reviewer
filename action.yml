name: "Agentic AI Code Reviewer"
description: "Agentic AI-powered review on every PR"
author: "TusharRoy23"

branding:
  icon: "zap"
  color: "blue"

inputs:
  trigger-phrase:
    description: "Keyword to trigger AI review"
    default: "@ai-code-reviewer review"

  review-mode:
    description: "Review mode: 'full' (entire PR) or 'incremental' (latest commit only)"
    default: "incremental"

  llm:
    description: "Large Language Model. Ex: gpt-4o-mini, deepseek-coder, etc."
    required: true
    default: "gpt-4o-mini"

  llm-api-key:
    description: "Large Language Model API KEY"
    required: true

runs:
  using: "composite"
  steps:
    # ------------------------------------------------------
    # 1. VALIDATION & SETUP
    # ------------------------------------------------------
    - name: Check trigger conditions
      id: check
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" != "pull_request" ]] && \
           [[ ! "${{ github.event.comment.body }}" =~ "${{ inputs.trigger-phrase }}" ]]; then
          echo "skip=true" >> $GITHUB_OUTPUT
          echo "Skipping: Not triggered by PR or trigger phrase"
        else
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "Conditions met, proceeding with review"
        fi

    - name: Checkout code
      if: steps.check.outputs.skip != 'true'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Need full history for incremental mode

    - name: Setup Node.js
      if: steps.check.outputs.skip != 'true'
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Enable corepack
      if: steps.check.outputs.skip != 'true'
      shell: bash
      run: corepack enable

    - name: Install action dependencies
      if: steps.check.outputs.skip != 'true'
      shell: bash
      working-directory: ${{ github.action_path }}
      run: |
        echo "Installing action dependencies from: ${{ github.action_path }}"

        # Check if package.json exists
        if [ ! -f package.json ]; then
          echo "No package.json found in action directory"
          exit 1
        fi

        # Install dependencies
        pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile

        echo "Action dependencies installed successfully"

    # ------------------------------------------------------
    # 2. DOWNLOAD DIFF (Full or Incremental)
    # ------------------------------------------------------
    - name: Set hardcoded limits
      shell: bash
      run: |
        echo "MAX_DIFF_KB=150" >> $GITHUB_ENV

    - name: Download PR diff
      if: steps.check.outputs.skip != 'true'
      id: diff
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
        REVIEW_MODE: ${{ inputs.review-mode }}
      run: |
        PR_NUM="${{ github.event.pull_request.number }}"
        if [ -z "$PR_NUM" ] || [ "$PR_NUM" = "null" ]; then
          PR_NUM="${{ github.event.issue.number }}"
        fi

        echo "PR Number: $PR_NUM"
        echo "Review Mode: $REVIEW_MODE"

        if [ "$REVIEW_MODE" = "incremental" ]; then
          echo "Incremental mode: Reviewing only the latest commit"
          
          # Get the latest commit SHA
          LATEST_COMMIT="${{ github.event.pull_request.head.sha }}"
          echo "Latest commit: $LATEST_COMMIT"
          
          # Get the previous commit (parent)
          if PREVIOUS_COMMIT=$(git rev-parse ${LATEST_COMMIT}^ 2>/dev/null); then
            echo "Previous commit: $PREVIOUS_COMMIT"
            # Generate diff for just the latest commit
            git diff $PREVIOUS_COMMIT $LATEST_COMMIT > pr.diff
          else
            echo "Could not find parent commit (might be first commit)"
            echo "Falling back to compare with base branch"
            # First commit in branch, compare with base
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            git diff $BASE_SHA $LATEST_COMMIT > pr.diff
          fi
          
          echo "Generated diff for latest commit only"
          
        else
          echo "Full mode: Reviewing entire PR"
          
          # Download full PR diff from GitHub API
          curl -sL \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3.diff" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUM" \
            > pr.diff
          
          echo "Downloaded full PR diff"
        fi

        SIZE=$(du -k pr.diff | cut -f1)
        echo "Diff size: ${SIZE} KB"

        if [ "$SIZE" -gt "${{ env.MAX_DIFF_KB }}" ]; then
          echo "Diff too large (${SIZE} KB > ${{ env.MAX_DIFF_KB }} KB). Skipping review."
          echo "large_diff=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        if [ "$SIZE" -eq 0 ]; then
          echo "Diff is empty (0 KB). Skipping review."
          echo "large_diff=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "large_diff=false" >> $GITHUB_OUTPUT

    - name: Filter meaningful code changes
      if: steps.check.outputs.skip != 'true' && steps.diff.outputs.large_diff != 'true'
      shell: bash
      run: |
        echo "Filtering diff for meaningful code changes..."

        ALLOWED_EXTENSIONS="(ts|tsx|js|jsx|py|java|go|cpp|c|rb|php|swift|rs|kt|scala|cs|html|css|scss|vue|svelte)"

        awk -v EXT="$ALLOWED_EXTENSIONS" '
          BEGIN { keep = 0; }

          /^diff --git / {
            match($0, / a\/([^ ]+) b\//, m);
            file=m[1];
            keep=0;

            # Include files with allowed extensions
            if (file ~ ("\\." EXT "$")) keep=1;

            # Exclude specific files
            if (file ~ /(^|\/)(package(-lock)?\.json)$/) keep=0;
            if (file ~ /(^|\/)pnpm-lock\.yaml$/) keep=0;
            if (file ~ /(^|\/)yarn\.lock$/) keep=0;
            if (file ~ /(^|\/)tsconfig.*\.json$/) keep=0;
            if (file ~ /(^|\/)\.(gitignore|gitattributes|editorconfig)$/) keep=0;
            if (file ~ /\.(md|txt|csv)$/) keep=0;
            if (file ~ /\.min\.(js|css)$/) keep=0;
            if (file ~ /\.map$/) keep=0;

            if (!keep) {
              printf "Skipping %s\n", file > "/dev/stderr";
            }
          }

          { if (keep) print; }
        ' pr.diff > pr.filtered.diff

        echo "Filtering complete"

    - name: Show files being reviewed
      if: steps.check.outputs.skip != 'true' && steps.diff.outputs.large_diff != 'true'
      shell: bash
      run: |
        FILE_COUNT=$(grep -c "^diff --git" pr.filtered.diff 2>/dev/null || echo "0")
        echo "Files being reviewed: $FILE_COUNT"

        if [ "$FILE_COUNT" -gt 0 ]; then
          awk '/^diff --git / { 
            match($0, / b\/(.+)$/, m); 
            if (m[1]) print "  - " m[1]; 
          }' pr.filtered.diff
        fi

    - name: Detect project info
      if: steps.check.outputs.skip != 'true'
      id: projectinfo
      shell: bash
      run: |
        echo "ğŸ” Detecting project information..."

        # Run the detector script from action directory
        INFO=$(node ${{ github.action_path }}/scripts/project-info-detector.js)

        echo "LLM=${{ inputs.llm }}" >> $GITHUB_ENV
        echo "LLM_API_KEY=${{ inputs.llm-api-key }}" >> $GITHUB_ENV

        # Check if INFO is valid JSON
        if ! echo "$INFO" | jq empty 2>/dev/null; then
          echo "Failed to detect project info, using defaults"
          echo "LANGUAGES=Unknown" >> $GITHUB_ENV
          echo "FRAMEWORKS=Unknown" >> $GITHUB_ENV
          echo "LIBRARIES=Unknown" >> $GITHUB_ENV
          echo "PROJECT_TYPE=general" >> $GITHUB_ENV
        else
          # Parse JSON and set env variables
          LANGS=$(echo "$INFO" | jq -r '.languages | join(",")')
          FRAMES=$(echo "$INFO" | jq -r '.frameworks | join(",")')
          LIBS=$(echo "$INFO" | jq -r '.libraries | join(",")')
          TYPE=$(echo "$INFO" | jq -r '.projectType')
          
          # Handle empty arrays
          if [ -z "$LANGS" ] || [ "$LANGS" = "null" ]; then
            LANGS="Unknown"
          fi
          if [ -z "$FRAMES" ] || [ "$FRAMES" = "null" ]; then
            FRAMES="None"
          fi
          if [ -z "$LIBS" ] || [ "$LIBS" = "null" ]; then
            LIBS="None"
          fi
          if [ -z "$TYPE" ] || [ "$TYPE" = "null" ]; then
            TYPE="general"
          fi
          
          echo "LANGUAGES=$LANGS" >> $GITHUB_ENV
          echo "FRAMEWORKS=$FRAMES" >> $GITHUB_ENV
          echo "LIBRARIES=$LIBS" >> $GITHUB_ENV
          echo "PROJECT_TYPE=$TYPE" >> $GITHUB_ENV
          
          echo "   Detected:"
          echo "   Languages: $LANGS"
          echo "   Frameworks: $FRAMES"
          echo "   Libraries: $LIBS"
          echo "   Type: $TYPE"
        fi

    # ------------------------------------------------------
    # 3. RUN AI REVIEW
    # ------------------------------------------------------
    - name: Run AI Code Review
      if: |
        steps.check.outputs.skip != 'true' && 
        steps.diff.outputs.large_diff != 'true'
      id: review
      shell: bash
      env:
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_REF: ${{ github.ref }}
      run: |
        if [ ! -s pr.filtered.diff ]; then
          echo "No meaningful code changes found"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "ğŸš€ Running AI Code Review..."

        # Run review and save ONLY stdout to review.json
        # Let stderr go to workflow logs (for debugging)
        node ${{ github.action_path }}/scripts/review-bot.js pr.filtered.diff | grep -v '^::' > review.json

        echo ""
        echo "ğŸ“Š DEBUG: Checking review.json..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        # Check file exists
        if [ ! -f review.json ]; then
          echo "âŒ review.json does not exist!"
          exit 1
        fi

        # Save raw file for inspection (before any processing)
        cp review.json review.json.raw
        echo "âœ… Saved raw file as review.json.raw"

        # Check file size
        FILE_SIZE=$(wc -c < review.json)
        echo "ğŸ“„ File size: $FILE_SIZE bytes"

        # Check if empty
        if [ "$FILE_SIZE" -eq 0 ]; then
          echo "âŒ review.json is empty!"
          exit 1
        fi

        # Show file content (first 500 chars)
        echo "ğŸ“ File content (first 500 chars):"
        head -c 500 review.json
        echo ""
        echo ""

        # Try to validate JSON with jq
        echo "ğŸ” Validating JSON structure..."
        if jq empty review.json 2>/dev/null; then
          echo "âœ… JSON is valid!"
          
          # Show structure
          echo ""
          echo "ğŸ“‹ JSON Structure:"
          jq 'type' review.json
          
          # If it's an array, show length
          if jq -e 'type == "array"' review.json > /dev/null 2>&1; then
            LENGTH=$(jq 'length' review.json)
            echo "   Array length: $LENGTH items"
          fi
          
          # If it's an object with error, show it
          if jq -e '.error' review.json > /dev/null 2>&1; then
            echo "âš ï¸  Response contains error:"
            jq '.error, .code' review.json
            exit 1
          fi
          
          echo ""
          echo "âœ… Review completed successfully"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
        else
          echo "âŒ JSON validation failed!"
          echo ""
          echo "ğŸ“‹ Full content:"
          cat review.json
          echo ""
          echo ""
          echo "ğŸ”§ Trying to diagnose..."
          
          # Try to show what jq error is
          jq '.' review.json 2>&1 || true
          
          exit 1
        fi

    # ============================================
    # POST REVIEW COMMENTS (only if review succeeded)
    # ============================================
    - name: Post review comments
      if: |
        steps.check.outputs.skip != 'true' &&
        steps.review.outputs.has_changes == 'true'
      shell: bash
      env:
        GITHUB_TOKEN: ${{ github.token }}
        REVIEW_MODE: ${{ inputs.review-mode }}
      run: |
        echo "ğŸ“ Posting review comments to PR..."

        if [ ! -f review.json ]; then
          echo "âŒ review.json not found!"
          exit 1
        fi

        node ${{ github.action_path }}/scripts/post-review.js review.json

    # ============================================
    # CLEANUP & DEBUG LOGS
    # ============================================
    - name: Upload debug logs (on any event)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: review-debug-files
        path: |
          review.json
          review.json.raw
          review-bot.debug.log
        retention-days: 7

    - name: Cleanup
      if: always()
      shell: bash
      run: |
        echo "ğŸ§¹ Cleaning up temporary files..."
        rm -f pr.diff pr.filtered.diff alldiff.tmp
        echo "âœ… Cleanup complete"
